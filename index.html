<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Asset Booking Form</title>

<style>

/* =========================
   CUSTOM BRAND FONTS
========================= */

@font-face {
  font-family: 'BasecampSans';
  src: url('BasecampSans.otf') format('opentype');
}

@font-face {
  font-family: 'GloryCulture';
  src: url('GloryCulture.ttf') format('truetype');
}

@font-face {
  font-family: 'Lumberjack';
  src: url('Lumberjack.ttf') format('truetype');
}

/* =========================
   GLOBAL STYLES
========================= */

body {
  margin: 0;
  padding: 0;
  background-color: #f5f5f5;
  color: #231f20;
  font-family: 'Lumberjack', sans-serif;
}

.wrapper {
  max-width: 850px;
  margin: 50px auto;
  background: white;
  padding: 45px;
  border-radius: 14px;
  box-shadow: 0 12px 35px rgba(0,0,0,0.08);
}

/* =========================
   HEADER
========================= */

.header {
  text-align: center;
  margin-bottom: 35px;
}

.header img {
  max-height: 110px;
  margin-bottom: 15px;
}

.header h1 {
  font-family: 'BasecampSans', sans-serif;
  font-size: 30px;
  margin: 0;
  letter-spacing: 1px;
  color: #231f20;
}

.subheader {
  font-family: 'GloryCulture', sans-serif;
  font-size: 18px;
  margin-top: 6px;
  color: #ed1c24;
}

/* =========================
   FORM SECTIONS
========================= */

.section {
  margin-bottom: 25px;
}

input, textarea {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  font-family: 'Lumberjack', sans-serif;
  transition: border 0.2s ease;
}

input:focus, textarea:focus {
  outline: none;
  border-color: #ed1c24;
}

/* =========================
   NOTICE BOX
========================= */

.notice {
  background-color: #fff5f5;
  border-left: 6px solid #ed1c24;
  padding: 18px;
  border-radius: 10px;
  text-align: center;
  font-size: 14px;
}

/* =========================
   ASSET CARDS
========================= */

.asset {
  border: 1px solid #ddd;
  padding: 18px;
  margin-bottom: 15px;
  border-radius: 12px;
  transition: 0.2s ease;
}

.asset:hover {
  border-color: #ed1c24;
  box-shadow: 0 6px 14px rgba(237,28,36,0.15);
}

.asset.disabled {
  opacity: 0.4;
}

/* =========================
   BUTTON
========================= */

button {
  padding: 14px 28px;
  font-size: 15px;
  border-radius: 10px;
  border: none;
  background-color: #ed1c24;
  color: white;
  font-family: 'BasecampSans', sans-serif;
  cursor: pointer;
  transition: 0.2s ease;
}

button:hover {
  background-color: #c5161c;
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* =========================
   LOADING + CONFIRMATION
========================= */

#loading {
  display: none;
  text-align: center;
  margin-bottom: 12px;
  font-style: italic;
}

#confirmation {
  display: none;
  text-align: center;
}

</style>
</head>

<body>

<div class="wrapper">

  <div class="header">
    <img src="DBShield.png" alt="DB Brewing Logo">
    <h1>ASSET BOOKING REQUEST</h1>
    <div class="subheader">Internal & External Event Use</div>
  </div>

  <div id="formSection">

    <div class="section">
      <input type="text" id="name" placeholder="Full Name" required>
      <input type="email" id="email" placeholder="Email Address" required>
      <input type="text" id="eventName" placeholder="Event Name">
      <textarea id="notes" placeholder="Additional Notes"></textarea>
    </div>

    <div class="section">
      <label><strong>Start Date</strong></label>
      <input type="date" id="startDate">
      <label><strong>End Date</strong></label>
      <input type="date" id="endDate">
    </div>

    <div class="section notice">
      <strong>Staffing Notice:</strong><br>
      Assets do not come with staffing. If you need staffing support,
      please email 
      <a href="mailto:eleanor.mason@dbbrewingcompany.com">
      eleanor.mason@dbbrewingcompany.com</a>
      with event details and number of staff requested.
    </div>

    <div class="section">
      <h3 style="text-align:center;">Select Assets</h3>
      <div id="loading">Loading assets...</div>
      <div id="assetsContainer"></div>
    </div>

    <div style="text-align:center;">
      <button id="submitBtn" onclick="submitBooking()" disabled>
        Submit Request
      </button>
    </div>

  </div>

  <div id="confirmation">
    <h2>Request Submitted</h2>
    <p>Your booking has been received.</p>
    <div id="guideLinks"></div>
    <p>Questions? Contact eleanor.mason@dbbrewingcompany.com</p>
  </div>

</div>

<script>

const API_URL = "https://script.google.com/macros/s/AKfycbzcgJrFWLGD3Gt2X4lNndwN4IEMU7vZNlMaPBuYtSwwqkd2pCBA4NIUxUgCbalZsL11tg/exec";

let assets = [];

const assetsContainer = document.getElementById("assetsContainer");
const loadingDiv = document.getElementById("loading");
const submitBtn = document.getElementById("submitBtn");

async function loadAssets() {
  loadingDiv.style.display = "block";
  submitBtn.disabled = true;

  try {
    const response = await fetch(`${API_URL}?action=getAssets`);
    assets = await response.json();
    renderAssets();
  } catch (err) {
    alert("Failed to load assets.");
  } finally {
    loadingDiv.style.display = "none";
    submitBtn.disabled = false;
  }
}

window.onload = loadAssets;

function renderAssets(unavailable = []) {
  assetsContainer.innerHTML = "";

  assets.forEach(asset => {
    const div = document.createElement("div");
    div.className = "asset";

    if (unavailable.includes(asset.name)) {
      div.classList.add("disabled");
    }

    div.innerHTML = `
      <label>
        <input type="checkbox" value="${asset.name}"
        ${unavailable.includes(asset.name) ? "disabled" : ""}>
        <strong>${asset.name}</strong>
      </label>
      <div>${asset.details}</div>
    `;

    assetsContainer.appendChild(div);
  });
}

document.getElementById("startDate").addEventListener("change", checkAvailability);
document.getElementById("endDate").addEventListener("change", checkAvailability);

async function checkAvailability() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  if (!start || !end) return;

  const response = await fetch(
    `${API_URL}?action=checkAvailability&start=${start}&end=${end}`
  );
  const unavailable = await response.json();
  renderAssets(unavailable);
}

async function submitBooking() {
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const eventName = document.getElementById("eventName").value.trim();
  const notes = document.getElementById("notes").value.trim();
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;

  const selectedAssets = Array.from(
    document.querySelectorAll("input[type=checkbox]:checked")
  ).map(cb => cb.value);

  if (!name || !email) return alert("Please enter your name and email.");
  if (!startDate || !endDate) return alert("Select start and end dates.");
  if (new Date(endDate) < new Date(startDate))
    return alert("End date cannot be before start date.");
  if (selectedAssets.length === 0)
    return alert("Select at least one asset.");

  const data = { name, email, eventName, notes, startDate, endDate, assets: selectedAssets };

  const response = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data)
  });

  const result = await response.json();
  if (result.error) return alert(result.error);

  document.getElementById("formSection").style.display = "none";
  document.getElementById("confirmation").style.display = "block";

  const guideDiv = document.getElementById("guideLinks");
  guideDiv.innerHTML = "";

  selectedAssets.forEach(assetName => {
    const asset = assets.find(a => a.name === assetName);
    if (asset && asset.guide) {
      guideDiv.innerHTML +=
        `<p><a href="${asset.guide}" target="_blank">${asset.name} Guide</a></p>`;
    }
  });
}

</script>

</body>
</html>
